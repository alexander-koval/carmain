<!-- Шаблон для отображения только списка деталей, требующих обслуживания -->
<div id="maintenance-items-list">
    {% if maintenance_items %}
    <div class="row" x-data="{}">
        {% for item in maintenance_items %}
        <div class="col-lg-6 mb-3">
            <div class="card shadow-sm h-100" style="border-top: 4px solid #ffe216; transition: all 0.2s ease;">
                <div class="card-body d-flex align-items-start position-relative">
                    {% if item.type == 'oil_change' %}
                    <i class="fas fa-oil-can fa-fw fa-2x me-3 text-muted"></i>
                    {% elif item.type == 'brake_pads' %}
                    <i class="fas fa-brake-system fa-fw fa-2x me-3 text-muted"></i>
                    {% elif item.type == 'timing_belt' %}
                    <i class="fas fa-cogs fa-fw fa-2x me-3 text-muted"></i>
                    {% elif item.type == 'air_filter' %}
                    <i class="fas fa-filter fa-fw fa-2x me-3 text-muted"></i>
                    {% elif item.type == 'battery' %}
                    <i class="fas fa-car-battery fa-fw fa-2x me-3 text-muted"></i>
                    {% else %}
                    <i class="fas fa-wrench fa-fw fa-2x me-3 text-muted"></i>
                    {% endif %}

                    <div class="flex-grow-1">
                        <h5 style="font-weight: bold; font-size: 1.1rem;">
                            <a href="/vehicles/{{ vehicle.id }}/maintenance-items/{{ item.id }}"
                               class="text-decoration-none text-dark stretched-link">{{ item.name }}</a>
                        </h5>
                        <p class="mb-1">
                            {% if item.status == 'overdue' %}
                            <span class="maintenance-badge badge-overdue">Просрочено</span>
                            <span class="ms-1">Превышение на {{ item.overdue_km }} км</span>
                            {% elif item.status == 'upcoming' %}
                            <span class="maintenance-badge badge-upcoming">Скоро</span>
                            <span class="ms-1">Осталось {{ item.remaining_km }} км</span>
                            {% elif item.status == 'never_serviced' %}
                            <span class="maintenance-badge badge-overdue">Не обслуживалась</span>
                            {% endif %}
                        </p>
                        {% if item.last_service_date %}
                        <p class="text-muted mb-0 small">
                            Последнее обслуживание: {{ item.last_service_date.strftime('%d.%m.%Y') }} ({{
                            item.last_service_odometer }} км)
                        </p>
                        {% endif %}
                    </div>

                    <button class="btn btn-sm btn-outline-success ms-2"
                            style="z-index: 2; position: relative;"
                            data-toggle="modal"
                            data-target="#serviceModal"
                            @click='$dispatch("open-service-modal", { id: {{ item.id|tojson }}, name: {{ item.name|tojson }} });'>
                        <i class="fas fa-check me-1"></i> Обслужено
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Пагинация (если нужна) -->
    {% if pagination.total_pages > 1 %}
    <nav aria-label="Навигация по страницам" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if pagination.current_page == 1 %}disabled{% endif %}">
                <a class="page-link"
                   href="#"
                   hx-get="/vehicles/{{ vehicle.id }}/maintenance?page={{ pagination.current_page - 1 }}"
                   hx-target="#maintenance-items-list"
                   hx-swap="outerHTML"
                   hx-push-url="true">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>

            {% for page in range(1, pagination.total_pages + 1) %}
            <li class="page-item {% if page == pagination.current_page %}active{% endif %}">
                <a class="page-link"
                   href="#"
                   hx-get="/vehicles/{{ vehicle.id }}/maintenance?page={{ page }}"
                   hx-target="#maintenance-items-list"
                   hx-swap="outerHTML"
                   hx-push-url="true">
                    {{ page }}
                </a>
            </li>
            {% endfor %}

            <li class="page-item {% if pagination.current_page == pagination.total_pages %}disabled{% endif %}">
                <a class="page-link"
                   href="#"
                   hx-get="/vehicles/{{ vehicle.id }}/maintenance?page={{ pagination.current_page + 1 }}"
                   hx-target="#maintenance-items-list"
                   hx-swap="outerHTML"
                   hx-push-url="true">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- Пустое состояние -->
    <div class="text-center mt-5 py-5">
        <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
        <h4>Ваш автомобиль полностью обслужен</h4>
        <p class="text-muted mb-4">В настоящий момент все отслеживаемые детали не требуют обслуживания.</p>
        <div class="d-flex justify-content-center gap-2">
            <a href="/vehicles/{{ vehicle.id }}/add-maintenance-item" class="btn btn-carmain">
                <i class="fas fa-plus-circle me-1"></i> Добавить деталь для отслеживания
            </a>
            <a href="/vehicles/{{ vehicle.id }}/all-maintenance-items" class="btn btn-outline-secondary">
                <i class="fas fa-list-ul me-1"></i> Посмотреть отслеживаемые детали
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Modal для подтверждения обслуживания -->
    <div class="modal fade"
         id="serviceModal"
         tabindex="-1"
         role="dialog"
         x-data="{
                             itemId: null,
                             itemName: '',
                             vehicleId: '{{ vehicle.id }}',
                             serviceDate: '{{ today }}',
                             serviceOdometer: {{ vehicle.odometer if vehicle.odometer else 'null' }},
                             serviceComment: '',
                             servicePhoto: null,
                             dynamicHxPostUrl: '',
                         }"
         @open-service-modal.window="
                             itemId = $event.detail.id;
                             itemName = $event.detail.name;
                             $root.querySelector('.modal-title').textContent = 'Подтверждение: ' + itemName;
                             serviceDate = '{{ today }}';
                             serviceOdometer = {{ vehicle.odometer if vehicle.odometer else 'null' }};
                             serviceComment = '';
                             if ($refs.servicePhotoInput) $refs.servicePhotoInput.value = null;
                             dynamicHxPostUrl = `/vehicles/${vehicleId}/maintenance-items/${itemId}/service`;
                            console.log('Alpine - Updated dynamicHxPostUrl:', dynamicHxPostUrl);

                            let form = $el.querySelector('#serviceForm');
                            if (form) {
                                form.setAttribute('hx-post', dynamicHxPostUrl);
                                htmx.process(form);
                            }
                         "
         @hidden.bs.modal="
                             itemId = null;
                             itemName = '';
                             dynamicHxPostUrl = '';
                             $root.querySelector('.modal-title').textContent = 'Подтверждение обслуживания';">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serviceModalLabel">Подтверждение обслуживания</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="serviceForm" :hx-post="dynamicHxPostUrl" hx-target="#maintenance-items-list"
                          hx-swap="outerHTML"  hx-encoding="multipart/form-data">
                        <input type="hidden" name="item_id" :value="itemId">
                        <div class="form-group">
                            <label for="serviceDate">Период обслуживания</label>
                            <input type="date" class="form-control" id="serviceDate" name="service_date"
                                   value="{{ today }}" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceOdometer">Показание одометра (км)</label>
                            <input type="number" class="form-control" id="serviceOdometer" name="service_odometer"
                                   value="{{ vehicle.odometer }}" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceComment">Комментарий</label>
                            <textarea class="form-control" id="serviceComment" name="service_comment"
                                      rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="servicePhoto">Фото</label>
                            <input type="file" class="form-control-file" id="servicePhoto" name="service_photo">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                    <button type="submit" form="serviceForm" class="btn btn-success">Обслужено</button>
                </div>
            </div>
        </div>
    </div>

</div>